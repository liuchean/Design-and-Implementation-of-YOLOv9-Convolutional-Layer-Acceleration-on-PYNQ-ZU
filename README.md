# Design and Implementation of YOLOv9 Convolutional Layer Acceleration on PYNQ-ZU



## 📘 論文簡介
---
### 1️⃣ 背景
####  深度學習（Deep Learning）與人工智慧（Artificial Intelligence, AI）近年來已成為推動科技發展的核心動力。其中，**影像識別技術**因在智慧監控、自駕車、醫學影像分析與工業檢測等領域具有廣泛應用價值，而備受研究與產業界關注。在眾多深度學習架構中，**YOLO** 演算法也已成為影像辨識的標竿，並持續推動相關應用的突破。
---
### 2️⃣ 待解決問題
CNN 的核心計算為 **卷積運算**，其特點是需要大量的矩陣乘法與加總操作。這類運算雖然單一，但計算量往往都很龐大，導致在傳統處理器（如 **ARM 或 x86 架構 CPU**）上常出現以下瓶頸：  
- **效能限制**：較難滿足即時影像辨識或邊緣裝置的低延遲需求。  
- **能耗過高**：如需加速就需要使用 GPU，但在邊緣裝置上，長時間使用 GPU 運算會造成電力消耗過大。   

#### 因此，如何解決卷積運算的效能瓶頸，成為影像辨識的一大問題。
---
### 3️⃣ 解決方案
本研究以 **PYNQ-ZU（FPGA 平台）** 作為實驗與設計基礎，針對 YOLOv9 模型的卷積層進行加速優化。  
研究重點包括：  
- **結構性平行化設計**：將卷積運算拆解為可並行處理的子模組，充分利用 FPGA 的邏輯資源。  
- **資料流（Dataflow）優化**：透過流水線化與記憶體存取規劃，降低資料搬移延遲，提升整體吞吐量。
- **硬體資源優化**：透過硬體資源優化，使FPGA能發揮出更強的能力。   
- **跨平台協作**：結合 ARM 與 FPGA 的異質運算架構，讓 ARM 負責控制與前處理，FPGA 專注於卷積加速。  

#### 藉由這些方法，FPGA 的高度並行特性得以最佳的發揮，不僅能顯著提升 YOLOv9 在邊緣運算環境下的效能與穩定度，也為未來低功耗、高效能的 AI 部署提供可行解決方案。
---

## 🔧 實作與開發環境
- **硬體平台**：Xilinx PYNQ-ZU (Zynq UltraScale+)  
- **開發工具**：Vitis HLS、Vivado、PYNQ Framework  
- **開發語言**：C / C++（硬體架構）、Python（控制與驗證）  

---

## ⚙️ 主要系統架構設計

### 1️⃣ EPIC（Enhanced Partition for Independent Convolution）架構設計背景
#### 在 PYNQ-ZU 平台上若直接執行卷積運算而未採用最佳化策略，將導致 FPGA 無法充分發揮並行運算優勢。因此，本研究提出 **EPIC 架構**，透過輸入與權重資料分割及多模組平行運算，達到更高的資料吞吐量與運算效率。
---
### 2️⃣ EPIC 架構說明
#### EPIC 架構將原先單一大型卷積模組拆分為 **四個可獨立運作的小型卷積模組**，使各模組能同時運算並互不干擾，再透過資料流（Dataflow）技術與可調整參數設計，實現更靈活的運算架構與高效能並行化。
---
### 3️⃣ 架構特點
- **輸入與權重分割**：  
  將資料分割為兩部分以避免記憶體存取衝突。  
- **多運算模組平行化**：  
  使用四個 `Conv` 模組同步運算，提升整體資料吞吐量。  
- **資料流優化 (Dataflow)**：  
  使資料傳輸與運算重疊，降低延遲。
- **Conv模組內部優化**：  
  通過對模組內部計算的優化，實現每個小模組內部的並行運算。  
- **參數彈性化設計**：  
  可根據不同卷積層動態調整參數設定。

#### ● EPIC 架構示意：
<img width="500" height="400" alt="EPIC Architecture" src="https://github.com/user-attachments/assets/a7e12ce5-4ef9-4228-8b46-3ab39c02b87e" />

#### ● Parallel Processing 模組：
<img width="500" height="293" alt="Parallel Processing" src="https://github.com/user-attachments/assets/acef31b0-70e0-4153-83b2-d67d63b79ffa" />

#### ● 模組功能總覽：

| 模組名稱 | 功能描述 |
|-----------|-----------|
| `EPIC` | 管理整體卷積運算流程 |
| `Parallel Processing` | 核心平行運算模組 |
| `Conv` | 卷積核心運算單元 |
| `Output Add` | 負責整合四個 Conv 模組的結果 |

---

## ⚙️ 硬體資源優化設計

### 1️⃣ 卷積 IP 共用設計

#### ● 共用動機 :
#### 在 FPGA 設計中，IP（Intellectual Property Core）相當於硬體的功能模組。然而，卷積神經網路（CNN）中的卷積層具有多樣化的參數組合，不同的參數會導致硬體佈局與資源需求差異。若為每一種參數組合都建立獨立 IP，不僅會造成 **邏輯資源浪費**，也會增加 **設計與維護成本**。因此，本論文提出 **IP 共用策略**，透過模板化設計，讓多種卷積設定能共用同一硬體架構，達到 **資源重複利用、降低設計複雜度** 的目標。
---
#### ● 共用策略 :
#### 為了實現 IP 共用，本研究針對卷積運算中常見的參數組合進行分析，挑選出具代表性的配置，並建立 **TIP (Template IP)** 作為基礎模組。並在 Vitis HLS 中，透過擴展 **EPIC (Efficient Parallel IP Convolution) 架構**，使得多個卷積任務能夠共用同一 TIP。  
此策略的核心概念包括：  
- **模板化設計**：將不同卷積參數抽象化為可配置的模板，避免重複生成多個獨立 IP。  
- **動態配置**：在運行時依據卷積需求，選擇合適的 TIP 進行運算。  
- **資源共享**：多個卷積層可共用相同的硬體邏輯，顯著降低 FPGA 的邏輯單元與記憶體消耗。  
#### 透過這樣的設計，能有效提升 FPGA 的 **資源利用率**，並兼顧靈活性與可擴展性。
---
#### ● 共用架構說明 :
在原有 **EPIC 架構** 的基礎上，進一步加入以下設計：  
1. **增加 Parallel Processing 模組數量**：  
     增加更多平行運算模組，能匹配不同規模的卷積運算，確保不同卷積層能在有限硬體資源下進行加速。
     
3. **運算規模判斷模組（Check）**：  
    根據輸入的卷積規模，分配合適的計算模組，避免小型卷積任務被分配到大型模組，導致額外延遲與資源浪費。 

<img width="400" height="430" alt="TIP Architecture" src="https://github.com/user-attachments/assets/073ff877-eb9e-4ffc-872c-a5daa9f02dc6" />

---

### 2️⃣ 儲存精度優化

#### ● 精度優化背景 :
#### 優化前，EPIC 中卷積運算的計算精度與 PyTorch 框架中所使用的 Conv2d 函數保持一致，所有資料均以 float32 格式進行處理。從下圖的結果可看出FPGA內部的 BRAM（Block Random Access Memory）資源佔用率高達86.11 %，此使用率稍高於 LUT（Look-Up Table）的70.72 %，並遠高於LUTRAM（Look-Up Table Random Access Memory）的 29 %及 FF（Flip-Flop）的 44 %、DSP(Digital Signal Processing)的 55%。可以從此結果得出，目前 EPIC 架構中 BRAM 的高占用是限制整體FPGA硬體設計擴展的主要瓶頸。

<img width="400" height="328" alt="BRAM Usage" src="https://github.com/user-attachments/assets/08af7a38-e07c-4046-8b2a-ac75433b045e" />

---
#### ● 資源瓶頸分析 :
- 高維度特徵圖以 32-bit 格式儲存，造成 BRAM 消耗極大。  
- YOLOv9 模型的特徵圖尺寸龐大，進一步加劇記憶體壓力。
---
#### ● 優化策略 :
#### 經過大量測試後採用 `ap_fixed<18,6>`（18-bit 固定小數格式）取代 `float32`，  
有效降低 BRAM 使用率並保持 **98% 的原始辨識精度**。  

> - **總位寬**：18 bit  
> - **整數位元**：6 bit（含符號位）  
> - **小數位元**：12 bit  
> - **精度表現**：辨識率維持約 98%，資源利用率提升 3 倍。

---

## ⚡ 效能比較結果

| 指標項目 | FPGA (PYNQ-ZU) | ARM Cortex-A53 | 提升幅度 |
|-----------|----------------|----------------|-----------|
| **執行時間** | 530.37 ms | 241.99 ms | 執行時間降低 **54.37%** |
| **運算穩定度（標準差）** | 0.11 | 2.48 | 運算穩定性大幅提升 |

> 🔹 本架構在資源優化後，實現三倍的硬體資源利用率 
> 🔹 保持原模型約 **98% 的推論準確率**

---

## 🧾 研究論文

> 劉哲安，《基於 FPGA 之 YOLOv9 平行化加速架構設計與實作》，  
> 國立台北大學通訊工程學系碩士論文，2025。

### 🎯 研究重點
- 針對 YOLOv9 模型中卷積層的高運算量問題，設計適用於 FPGA 的加速架構。

### 🧩 技術貢獻
- 結合 C/C++ 與 Python 進行軟硬體協同設計。  
- 在有限硬體資源下完成多維度硬體資源優化（運算單元配置、記憶體策略）。  
- 完成實際 FPGA 部署與效能驗證，確保穩定性與可行性。

